name: "Perform Release"

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  issue_comment:
    types: [created]

jobs:
  check-for-release-comment:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the PR branch
      - name: Fetch PR information
        id: pr-info
        run: |
          gh api \
          -H "Accept: application/vnd.github+json" \
          --hostname github.com \
          /repos/frecherenkel60/test-action/pulls/${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR Branch
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ fromJson(steps.pr-info.outputs.data).head.repo.full_name }}
          ref: ${{ fromJson(steps.pr-info.outputs.data).head.ref }}

      - name: Debug PR title
        run: |
          echo "PR Title: ${{ github.event.issue.title }}"

      - name: Block PR 2
        if: ${{ !startsWith(github.event.issue.title, 'Release to') }}
        run: |
          echo "Blocking PR merge 2."
          exit 1  # Block the merge by failing the check

      - name: Block PR if it is not a release comment on a release pull request
        if: ${{ github.event.comment.body != '/perform-release' }}
        run: |
          echo "Blocking PR merge 3."
          exit 1

      # Step 2: Detect /perform-release comment and perform the release action
      - name: Perform release action
        if: ${{ github.event.comment.body == '/perform-release' }}
        run: |
          echo "Release approval comment detected. Performing release action..."
          exit 0
          # Add your release logic here
          # Example: Run a script, trigger deployment, etc.
